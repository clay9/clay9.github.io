<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-09-09 Mon 12:14 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>游戏服务器简易说明</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="王成庆" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>

<script type="text/javascript" src="script/org-info.js">
/**
 *
 * @source: script/org-info.js
 *
 * @licstart  The following is the entire license notice for the
 *  JavaScript code in script/org-info.js.
 *
 * Copyright (C) 2012-2019 Free Software Foundation, Inc.
 *
 *
 * The JavaScript code in this tag is free software: you can
 * redistribute it and/or modify it under the terms of the GNU
 * General Public License (GNU GPL) as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option)
 * any later version.  The code is distributed WITHOUT ANY WARRANTY;
 * without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.
 *
 * As additional permission under GNU GPL version 3 section 7, you
 * may distribute non-source (e.g., minimized or compacted) forms of
 * that code without the copy of the GNU GPL normally required by
 * section 4, provided you include this license notice and a URL
 * through which recipients can access the Corresponding Source.
 *
 * @licend  The above is the entire license notice
 * for the JavaScript code in script/org-info.js.
 *
 */
</script>

<script type="text/javascript">

/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/

<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "http://wcq.fun");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="http://wcq.fun"> HOME </a>
</div><div id="content">
<h1 class="title">游戏服务器简易说明</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org0c0ddb7">1. <span class="todo PROJECT">PROJECT</span> 游戏服务器 版本说明</a>
<ul>
<li><a href="#orgeeba84f">1.1. <span class="done DONE">DONE</span> frame框架 v0.1</a></li>
<li><a href="#orge44be35">1.2. <span class="done DONE">DONE</span> frame框架 v0.2</a></li>
<li><a href="#org4b1b687">1.3. <span class="todo TODO">TODO</span> frame框架 v0.3</a></li>
<li><a href="#org66fdaba">1.4. frame框架 v0.4</a></li>
</ul>
</li>
<li><a href="#orgc0315cb">2. <span class="todo PROJECT">PROJECT</span> 游戏服务器 基础知识</a>
<ul>
<li><a href="#org01ca06c">2.1. <span class="done DONE">DONE</span> 分布式</a>
<ul>
<li><a href="#org15ff8ef">2.1.1. 架构图</a></li>
<li><a href="#orgb516e41">2.1.2. cfg [ip, port] 配置问题</a></li>
<li><a href="#orga9e24b6">2.1.3. 端口生成规则&#xa0;&#xa0;&#xa0;<span class="tag"><span class="TODOLATER">TODOLATER</span></span></a></li>
</ul>
</li>
<li><a href="#org1886236">2.2. <span class="done DONE">DONE</span> 多游戏支持</a>
<ul>
<li><a href="#orgdced8ae">2.2.1. 房间号生成规则</a></li>
</ul>
</li>
<li><a href="#org407316b">2.3. <span class="done DONE">DONE</span> frame与sub交互</a>
<ul>
<li><a href="#org1df7b4b">2.3.1. msg</a></li>
</ul>
</li>
<li><a href="#orgd5c93c5">2.4. <span class="todo TODO">TODO</span> 房卡场, 金币场, 俱乐部</a>
<ul>
<li><a href="#org3ce04d4">2.4.1. 消息号</a></li>
<li><a href="#orgd39018c">2.4.2. 创建流程&#xa0;&#xa0;&#xa0;<span class="tag"><span class="TODOLATER">TODOLATER</span></span></a></li>
<li><a href="#orgda04e29">2.4.3. 加入流程</a></li>
<li><a href="#org205366b">2.4.4. 遗留问题</a></li>
</ul>
</li>
<li><a href="#orga284079">2.5. 比赛场&#xa0;&#xa0;&#xa0;<span class="tag"><span class="TODOLATER">TODOLATER</span></span></a>
<ul>
<li><a href="#org8ca105a">2.5.1. 消息号</a></li>
<li><a href="#orgc865116">2.5.2. 主要类</a></li>
<li><a href="#orgcdf919f">2.5.3. 房间生成方式</a></li>
<li><a href="#orgb851057">2.5.4. 加入流程</a></li>
</ul>
</li>
<li><a href="#orgdcf1801">2.6. <span class="done DONE">DONE</span> 战绩记录 &amp;&amp; 录像回放</a>
<ul>
<li><a href="#orgcdd6779">2.6.1. 需要处理</a></li>
</ul>
</li>
<li><a href="#orgd6edefe">2.7. 机器人</a>
<ul>
<li><a href="#orga0b737a">2.7.1. 设计思路</a></li>
<li><a href="#org911513d">2.7.2. RobotManager初始化</a></li>
<li><a href="#orgab6b4c3">2.7.3. GameRoom初始化机器人</a></li>
<li><a href="#org7a305e5">2.7.4. 遗留问题</a></li>
<li><a href="#org550b4ad">2.7.5. 修改范围</a></li>
</ul>
</li>
<li><a href="#org3109f9a">2.8. <span class="done DONE">DONE</span> GameRoom</a>
<ul>
<li><a href="#org3ebdae6">2.8.1. player与gameroom交互</a></li>
</ul>
</li>
<li><a href="#orgda54f3f">2.9. sub框架整理</a></li>
<li><a href="#org09c3127">2.10. <span class="done DONE">DONE</span> 常用结构体</a>
<ul>
<li><a href="#org7081978">2.10.1. Msg数据包</a></li>
<li><a href="#org836330c">2.10.2. 常用enum</a></li>
</ul>
</li>
<li><a href="#orgaa04cab">2.11. <span class="done DONE">DONE</span> 有趣的bug</a></li>
<li><a href="#orga7005f6">2.12. <span class="done DONE">DONE</span> 底层接口</a>
<ul>
<li><a href="#org0eb1183">2.12.1. 流程</a></li>
</ul>
</li>
<li><a href="#org0a7c1ec">2.13. <span class="done DONE">DONE</span> DB多线程</a>
<ul>
<li><a href="#orgbc1c9f6">2.13.1. 流程</a></li>
</ul>
</li>
<li><a href="#org464ff9b">2.14. 定时器</a></li>
<li><a href="#org7f7239b">2.15. <span class="todo TODO">TODO</span> 进程管理工程</a>
<ul>
<li><a href="#org5871252">2.15.1. 设计考量</a></li>
<li><a href="#org8f7f558">2.15.2. 需要的类</a></li>
<li><a href="#org89e51a9">2.15.3. 使用的技术</a></li>
</ul>
</li>
<li><a href="#org1696a5c">2.16. 当前服务器缺陷</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org0c0ddb7" class="outline-2">
<h2 id="org0c0ddb7"><span class="section-number-2">1</span> <span class="todo PROJECT">PROJECT</span> 游戏服务器 版本说明</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgeeba84f" class="outline-3">
<h3 id="orgeeba84f"><span class="section-number-3">1.1</span> <span class="done DONE">DONE</span> frame框架 v0.1</h3>
<div class="outline-text-3" id="text-1-1">
<p>
主要修改内容:
</p>
<ol class="org-ol">
<li>GameServer::GameRoom拆分
<ul class="org-ul">
<li>frame代码</li>
<li>subgame代码</li>
</ul></li>
<li>GameServer::HandleFromGate, GameServer::HandleFromLobby适配新的GameRoom</li>
<li>比赛场功能适配新的GameRoom</li>
<li>subgame单独编译为so, 供frame加载</li>
</ol>

<p>
总结:
</p>
<ol class="org-ol">
<li>删除GameRoom大部分代码</li>
<li>保证了当前游戏(晃晃)的机器人功能</li>
</ol>
</div>
</div>

<div id="outline-container-orge44be35" class="outline-3">
<h3 id="orge44be35"><span class="section-number-3">1.2</span> <span class="done DONE">DONE</span> frame框架 v0.2</h3>
<div class="outline-text-3" id="text-1-2">
<p>
主要修改范围:
</p>
<ol class="org-ol">
<li>frame与sub代码分离, sub单独编译</li>
<li>frame提供
<ul class="org-ul">
<li>frame接口 GameRoomFrameIF</li>
<li>sub接口   GameRoomSubIF</li>
</ul></li>
<li>frame提供的接口
<ul class="org-ul">
<li>log日志</li>
<li>GameServer::GameRoom 流程函数</li>
<li>配置文件读取</li>
<li>录像回放</li>
</ul></li>
<li>subgame模板基本功能</li>
</ol>

<p>
总结:
</p>
<ol class="org-ol">
<li><p>
frame中游戏模型抽象为
</p>
<p>
<del>---------</del>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">start</td>
</tr>
</tbody>
</table>
<p>
<del>---------</del>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
v
</p>
<p>
<del>---------</del>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">XJ end</td>
</tr>
</tbody>
</table>
<p>
<del>---------</del>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<tbody>
<tr>
</tr>
</tbody>
</table>
<p>
v
</p>
<p>
<del>----------</del>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">DJ end</td>
</tr>
</tbody>
</table>
<p>
<del>----------</del>
</p></li>
<li>subgame将frmae中的游戏模型扩展</li>
</ol>
</div>
</div>

<div id="outline-container-org4b1b687" class="outline-3">
<h3 id="org4b1b687"><span class="section-number-3">1.3</span> <span class="todo TODO">TODO</span> frame框架 v0.3</h3>
<div class="outline-text-3" id="text-1-3">
<p>
主要改动范围:
</p>
<ol class="org-ol">
<li>frame接口  : 定时器
<ul class="org-ul">
<li>定时器标识 Timer的修改
底层定时器不再修改并返回Timer, 而是以传入的值为Timer</li>
<li>定时器调用函数 &amp;&amp; 定时器处理函数   都可以附带自定义参数</li>
</ul></li>
<li>frame接口  : 战绩记录</li>
<li>frame接口  : 房间规则</li>
<li>frame接口  :</li>
<li>sub模板功能完善</li>
</ol>

<p>
总结:
</p>
<ol class="org-ol">
<li>优化接口</li>
</ol>
</div>
</div>

<div id="outline-container-org66fdaba" class="outline-3">
<h3 id="org66fdaba"><span class="section-number-3">1.4</span> frame框架 v0.4</h3>
<div class="outline-text-3" id="text-1-4">
<p>
主要改动范围:
</p>
<ol class="org-ol">
<li>组织架构
lobby, game, db
<ol class="org-ol">
<li>game与db交互</li>
<li>lobby剥离出center server</li>
</ol></li>
<li>节点群处理
多服务器搭建共同节点</li>
<li>容错率
当服务器崩溃时, 可以把数据无缝转移</li>
</ol>
</div>
</div>
</div>


<div id="outline-container-orgc0315cb" class="outline-2">
<h2 id="orgc0315cb"><span class="section-number-2">2</span> <span class="todo PROJECT">PROJECT</span> 游戏服务器 基础知识</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org01ca06c" class="outline-3">
<h3 id="org01ca06c"><span class="section-number-3">2.1</span> <span class="done DONE">DONE</span> 分布式</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-08-05 Mon] </span></span> [done]</li>
</ul>
</div>
<div id="outline-container-org15ff8ef" class="outline-4">
<h4 id="org15ff8ef"><span class="section-number-4">2.1.1</span> 架构图</h4>
<div class="outline-text-4" id="text-2-1-1">
<pre class="example">

    	  lob.cfg   +-------+ 	连接记录      +--------+  连接记录      +--------+
  --- 	   &lt;------   | lobby | 	----------&gt;   | gate   |  ----------&gt;	| client |
 /   \	   ------&gt;   +-------+ 	&lt;----------   +--------+  &lt;----------  	+--------+
/     \   连接记录   ^  |   gate.cfg gameID推算          配置文件	 ^    |
| DB  |	      |	 v						 |    |
\     /             +-------+	 连接记录     +--------+    连接记录  	 |    |
 \   /	      	     |  game | 	----------&gt;   | gate   |  ---------------+    |
  ---	       	     +-------+ 	&lt;----------   +--------+  &lt;-------------------+
	    	   /	      gate.cfg gameID推算           lobby告之
	   	  /
       	   	 /
		/
       	  1. game  -&gt; lobby: game.cfg
	  2. lobby -&gt; game : 连接记录

</pre>
</div>
</div>

<div id="outline-container-orgb516e41" class="outline-4">
<h4 id="orgb516e41"><span class="section-number-4">2.1.2</span> cfg [ip, port] 配置问题</h4>
<div class="outline-text-4" id="text-2-1-2">
<ol class="org-ol">
<li><p>
socket发送消息会通过哪个网卡发送
测试 &#x2013; 局域网
</p>
<ol class="org-ol">
<li>lobby, game在一台服务器
现象: game.cfg.lobbyIP   = 127.0.0.1
结果: lobbyserver.gameIP = 127.0.0.1</li>
<li>lobby game在一台服务器
现象: game.cfg.lobbyIP   = 192.168.0.120
结果: lobbyserver.gameIP = 192.168.0.120</li>
<li>lobby, game不在一台服务器
现象: game.cfg.lobbyIP   = 192.168.0.253
结果: lobbyserver.gameIP = 192.168.0.120</li>
</ol>
<p>
测试 &#x2013; Internet网
</p>
<ol class="org-ol">
<li>lobby, game在一台服务器
未测试</li>
<li>lobby, game不在一台服务器
未测试</li>
</ol>

<p>
结论:
game连接lobby的ip地址, 决定了game使用哪个网卡发送
</p>
<ol class="org-ol">
<li>lobbyIPInGame = 127.0.0.1 则使用lo发送</li>
<li>lobbyIPInGame = 局域网ip, 则使用局域网网卡</li>
<li>lobbyIPInGame = internet, 则使用外网网卡</li>
</ol></li>
<li>所以cfg配置如下:
测试的话, 一般在局域网,  则选用局域网IP
运营的话, 肯定在internet,则选用外网IP</li>
</ol>
</div>
</div>

<div id="outline-container-orga9e24b6" class="outline-4">
<h4 id="orga9e24b6"><span class="section-number-4">2.1.3</span> 端口生成规则&#xa0;&#xa0;&#xa0;<span class="tag"><span class="TODOLATER">TODOLATER</span></span></h4>
<div class="outline-text-4" id="text-2-1-3">
<p>
<a href="SystemModule/LobbyServer/GameCtrl.h#org07c1689">具体实现</a>
同一服务器, 各进程(lobby,game,gate)端口号必须唯一
</p>

<p>
方案:
</p>
<ol class="org-ol">
<li class="on"><code>[X]</code> 由一台协调服统一分配
采用:
<ol class="org-ol">
<li>game启动时候, 向lobby申请端口, lobby返回给game</li>
<li>[lobby, gmae] 与 gate的端口关系为固定值
gateport = server.port + 4100</li>
</ol></li>
<li class="off"><code>[&#xa0;]</code> 各个进程, 读取数据库, 然后自动生成
舍弃: game现在不与DB通信, 修改起来太麻烦</li>
</ol>

<p>
遗留问题:
</p>
<ol class="org-ol">
<li>多网卡下, lobby无法识别game是否与自己在同一台服务器; 容易导致端口分配失败;</li>
<li>lobby生成port的函数是根据gameid写死的
port = (kindid &lt;&lt; 8) + nodeid + 2000
之所以写死, 是因为:
虽然lobby通知了gameserver, 但是没有通知到gateserver</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org1886236" class="outline-3">
<h3 id="org1886236"><span class="section-number-3">2.2</span> <span class="done DONE">DONE</span> 多游戏支持</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-08-05 Mon] </span></span> [done]</li>
</ul>
</div>
<div id="outline-container-orgdced8ae" class="outline-4">
<h4 id="orgdced8ae"><span class="section-number-4">2.2.1</span> 房间号生成规则</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
多游戏支持, 对于相同的kind, 房间号必须唯一
</p>

<ol class="org-ol">
<li class="off"><code>[&#xa0;]</code> roomid中可以反推出serverid</li>
<li class="on"><code>[X]</code> gameRoom中记录serverid
暂时使用这个方案</li>
</ol>

<p>
遗留问题:
</p>
<ol class="org-ol">
<li>修改房间流程的时候, 需要使用第一种方案;
因为现在是由lobby给game分配roomid,
之后game之间不互通, 只能使用方案1</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org407316b" class="outline-3">
<h3 id="org407316b"><span class="section-number-3">2.3</span> <span class="done DONE">DONE</span> frame与sub交互</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-08-05 Mon] </span></span> [done]</li>
</ul>
</div>
<div id="outline-container-org1df7b4b" class="outline-4">
<h4 id="org1df7b4b"><span class="section-number-4">2.3.1</span> msg</h4>
<div class="outline-text-4" id="text-2-3-1">
<ol class="org-ol">
<li>frame: NetMsg.decode时候保留原始数据</li>
<li>frame: handleMsg的时候转发给sub</li>
<li>sub: 把原始数据转为具体的结构体</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgd5c93c5" class="outline-3">
<h3 id="orgd5c93c5"><span class="section-number-3">2.4</span> <span class="todo TODO">TODO</span> 房卡场, 金币场, 俱乐部</h3>
<div class="outline-text-3" id="text-2-4">
</div>
<div id="outline-container-org3ce04d4" class="outline-4">
<h4 id="org3ce04d4"><span class="section-number-4">2.4.1</span> 消息号</h4>
<div class="outline-text-4" id="text-2-4-1">
<ol class="org-ol">
<li>房卡场 | 俱乐部
创建: C2M<sub>PYQ</sub><sub>PLAYER</sub><sub>CREATE</sub><sub>ROOM</sub><sub>SYN</sub>
加入: C2M<sub>PYQ</sub><sub>PLAYER</sub><sub>REQ</sub><sub>ENTER</sub><sub>ROOM</sub><sub>SYN</sub></li>
<li>金币场
server查询请求 &#x2013;
创建 | 加入  C2L<sub>REQUEST</sub><sub>ENTER</sub><sub>GOLD</sub><sub>ROOM</sub>
<a href="SystemModule/LobbyServer/HandlerFromGate.cpp#org8ad5707">C2L<sub>REQUEST</sub><sub>TNTER</sub><sub>GOLD</sub><sub>ROOM</sub></a></li>
</ol>
</div>
</div>
<div id="outline-container-orgd39018c" class="outline-4">
<h4 id="orgd39018c"><span class="section-number-4">2.4.2</span> 创建流程&#xa0;&#xa0;&#xa0;<span class="tag"><span class="TODOLATER">TODOLATER</span></span></h4>
<div class="outline-text-4" id="text-2-4-2">
<ol class="org-ol">
<li>client向lobby发起请求</li>
<li>lobby自己创建房间 &#x2013; 生成roomid, 并记录对应的serverid</li>
<li>如果是new room, 通知DB记录</li>
<li><a href="SystemModule/LobbyServer/HandlerFromDB.cpp#org75f385a">DB返回给lobby, lobby通知game</a></li>
<li><a href="SystemModule/GameServer/HandlerFromLobby.cpp#orgaa8facf">game创建完房间, 通知lobby</a></li>
<li><a href="SystemModule/LobbyServer/HandlerFromGame.cpp#orged48a45">lobby通知client</a></li>
<li>client连接game</li>
<li>game向lobby确认</li>
<li>lobby返回确认结果给game</li>
<li>game通知client, lobby</li>
</ol>

<p>
遗留问题:
</p>
<ol class="org-ol">
<li>流程修改为: game中先创建room, lobby映射 &amp;&amp; 写入数据库</li>
<li>函数命名修改: 金币场的流程使用了之前房卡场的流程, 需要修改函数的命名</li>
<li>Lobby/GoldRoomManager这个类应该删除</li>
<li>Lobby/GameRoom 删除无用数据</li>
</ol>
</div>
</div>
<div id="outline-container-orgda04e29" class="outline-4">
<h4 id="orgda04e29"><span class="section-number-4">2.4.3</span> 加入流程</h4>
<div class="outline-text-4" id="text-2-4-3">
<ol class="org-ol">
<li>client向lobby发起请求</li>
<li>lobby返回给client</li>
<li>client连接game</li>
<li>game向client确认</li>
<li>client返回确认结果给game</li>
<li>game通知client, lobby</li>
</ol>
</div>
</div>
<div id="outline-container-org205366b" class="outline-4">
<h4 id="org205366b"><span class="section-number-4">2.4.4</span> 遗留问题</h4>
<div class="outline-text-4" id="text-2-4-4">
<p>
遗留问题
</p>
<ol class="org-ol">
<li>推荐房间.
之前逻辑: 金币房预创建, 所以这里可以显示
替代方案: lobby给client虚拟数据(room还未创建), client点击时, lobby将已坐椅子数传递给game;
	  game根据已做椅子数 创建机器人.
胡总方案: game中的机器人创建room (2019.8.6 15:30)</li>
<li>因为暂时无机器人, 测试模拟房卡场</li>
</ol>

<p>
需要优化:
</p>
<ol class="org-ol">
<li>lobby, gmae创建房间的流程</li>
<li>房间规则  &#x2013; 来源与流程</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orga284079" class="outline-3">
<h3 id="orga284079"><span class="section-number-3">2.5</span> 比赛场&#xa0;&#xa0;&#xa0;<span class="tag"><span class="TODOLATER">TODOLATER</span></span></h3>
<div class="outline-text-3" id="text-2-5">
</div>
<div id="outline-container-org8ca105a" class="outline-4">
<h4 id="org8ca105a"><span class="section-number-4">2.5.1</span> 消息号</h4>
<div class="outline-text-4" id="text-2-5-1">
<p>
加入  C2L<sub>MATCH</sub><sub>APPLY</sub>
</p>
</div>
</div>
<div id="outline-container-orgc865116" class="outline-4">
<h4 id="orgc865116"><span class="section-number-4">2.5.2</span> 主要类</h4>
<div class="outline-text-4" id="text-2-5-2">
<ol class="org-ol">
<li>match<sub>manager管理</sub> 比赛场列表</li>
<li>match<sub>item表示一个比赛场</sub>, 管理比赛场房间</li>
<li>match<sub>room表示某个比赛场的某个房间</sub></li>
</ol>
</div>
</div>

<div id="outline-container-orgcdf919f" class="outline-4">
<h4 id="orgcdf919f"><span class="section-number-4">2.5.3</span> 房间生成方式</h4>
<div class="outline-text-4" id="text-2-5-3">
<p>
GameCtrl::Run()中向DB查询所有比赛信息,
match<sub>manager</sub>::on<sub>read</sub><sub>match</sub><sub>config</sub>()中创建match<sub>item信息</sub>,
并为每一个match<sub>item创建一个match</sub><sub>rom</sub>, 当做wait<sub>room</sub>, 等候区
当wait<sub>room人满之后</sub>, wait<sub>room变为正常的match</sub><sub>room</sub>; 然后生成一个新的wait<sub>room</sub>
</p>

<p>
注: wait<sub>room与match</sub><sub>room没有本质上的区别</sub>, 只是为了逻辑上比较清晰处理
</p>

<p>
TODONOW 待确认: 比赛场中的GameServer的roomid生成是否符合条件
</p>
</div>
</div>

<div id="outline-container-orgb851057" class="outline-4">
<h4 id="orgb851057"><span class="section-number-4">2.5.4</span> 加入流程</h4>
<div class="outline-text-4" id="text-2-5-4">
<p>
client &#x2013;&gt; lobby  &#x2013;&gt; game &#x2013;&gt; lobby &#x2013;&gt; client
lobby随机选择一个GameServer,  并通知该GameServer
GameServer 返回roomid等信息 给lobby
lobby根据roomID找到ServerID, 从而找到GameServer信息
然后lobby通知client
</p>

<p>
已有问题:
</p>
<ol class="org-ol">
<li>比赛场 同一个kind能否开多个GameMatchServer
考虑因素: 比赛场中所有桌子上的人需要一起比较数据, 如果不在同一个ServerID上, 则会出现问题
替代方案: 比赛场有多种模式, 同一个Kind下同一个模式, 只能在同一个Server上
方案结果: 不能; 一个kind上只能有一个GameMatchServer
结    论: 一个kind只能开一个GameMatchServer</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgdcf1801" class="outline-3">
<h3 id="orgdcf1801"><span class="section-number-3">2.6</span> <span class="done DONE">DONE</span> 战绩记录 &amp;&amp; 录像回放</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-09-09 Mon] </span></span> [done]</li>
</ul>
<p>
<a href="SystemModule/DBProxyServer/HandlerFromGame.cpp#org744657c">MSG<sub>M2L</sub><sub>GAME</sub><sub>RECORD</sub></a> &#x2013; 写入数据库, [战绩,回放]一起写入了
<a href="SystemModule/DBProxyServer/HandlerFromGame.cpp#org128c975">D2L<sub>PLAYER</sub><sub>COMBAT</sub><sub>GAINS</sub></a> &#x2013; 战绩记录 查询
<a href="SystemModule/LobbyServer/HandlerFromDB.cpp#orgd7bb68b">MSG<sub>D2L</sub><sub>GAME</sub><sub>REPLAY</sub></a>     &#x2013; 录像回 放查询
</p>

<p>
总结:
</p>
<ol class="org-ol">
<li>MSG<sub>M2L</sub><sub>GAME</sub><sub>RECORD</sub>
消息号在frame定义,
结构体定义在frame中</li>

<li>MSG<sub>L2C</sub><sub>GAME</sub><sub>REPLAY</sub>
消息号在frame定义，
结构体定义在subgame中, 各个subgame结构体不同</li>
</ol>

<p>
场景模拟: 写入
</p>
<ol class="org-ol">
<li>小局结束, subgame将结构体发送给frame, frame转发给DB 存储
<ol class="org-ol">
<li>结构体定义在subgame的message.proto中, 但是没必要定义消息号;</li>
<li>frame中定义消息号; 但是没法定义结构体(各个子游戏不同); 所以frmae中必须定义一个通用的泛结构体</li>
</ol></li>
<li>DB写入; DB会获取泛数据, 不认识的数据会直接写入</li>
</ol>

<p>
场景模拟: 查询
</p>
<ol class="org-ol">
<li>client向lobby发送录像回放
<ol class="org-ol">
<li>frmae中定义了查询消息号, 查询结构体;</li>
</ol></li>
<li>lobby收到之后去DB查询</li>
<li>将数据原封不动的发送给client
<ol class="org-ol">
<li>frame中定义了消息号, 并返回给client泛数据</li>
</ol></li>
<li>client收到数据后, 转发给具体的子游戏
<ol class="org-ol">
<li>子游戏处理函数中, 把泛型转换为具体数据;  子游戏的message.proto中有具体结构体定义</li>
</ol></li>
</ol>

<p>
遗留问题
</p>
<ol class="org-ol">
<li>根据roomid 查询房间号 &#x2013;&gt; 不同时刻可能会有多个房间号</li>
<li>删除replay<sub>id的查询方式</sub></li>
</ol>
</div>
<div id="outline-container-orgcdd6779" class="outline-4">
<h4 id="orgcdd6779"><span class="section-number-4">2.6.1</span> 需要处理</h4>
<div class="outline-text-4" id="text-2-6-1">
<ol class="org-ol">
<li>战绩记录查询
查询不到数据, 需要再确认下</li>

<li>录像回放 &#x2013; 数据序列化问题
<ol class="org-ol">
<li>数据传输到DB</li>
<li>序列化方法</li>
</ol></li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgd6edefe" class="outline-3">
<h3 id="orgd6edefe"><span class="section-number-3">2.7</span> 机器人</h3>
<div class="outline-text-3" id="text-2-7">
</div>
<div id="outline-container-orga0b737a" class="outline-4">
<h4 id="orga0b737a"><span class="section-number-4">2.7.1</span> 设计思路</h4>
<div class="outline-text-4" id="text-2-7-1">
<p>
basic:
</p>
<ol class="org-ol">
<li>机器人与lobby没有任何关系, 只在game中出现</li>
<li>机器人使用playermanager类管理, 字段区分玩家和机器人</li>
<li>机器人子游戏逻辑调用托管逻辑, 不需要重新写</li>
</ol>
</div>
</div>
<div id="outline-container-org911513d" class="outline-4">
<h4 id="org911513d"><span class="section-number-4">2.7.2</span> RobotManager初始化</h4>
<div class="outline-text-4" id="text-2-7-2">
<ol class="org-ol">
<li><a href="SystemModule/GameServer/GameCtrl.cpp#orgadf4756">gameserver启动时候, 根据robot.cfg中的机器人数目向lobby请求初始化机器人</a>
请求内容
<ol class="org-ol">
<li>机器人配置信息</li>
<li>机器人玩家</li>
</ol></li>
<li>lobby向db做出查询</li>
<li>db查询并返回所有的机器人给lobby</li>
<li>lobby通知game</li>
</ol>
</div>
</div>
<div id="outline-container-orgab6b4c3" class="outline-4">
<h4 id="orgab6b4c3"><span class="section-number-4">2.7.3</span> GameRoom初始化机器人</h4>
<div class="outline-text-4" id="text-2-7-3">
<ol class="org-ol">
<li>GameRoom中根据房间椅子数生成robot rand数目</li>
<li><a href="SystemModule/AICode/RobotManager.cpp#org4c7ba8d">RobotManager在初始化机器人的时候, 开启了定时器, 用来控制机器人进出房间</a></li>
<li>在定时器中控制了机器人是否加入还是离开房间</li>
</ol>
</div>
</div>

<div id="outline-container-org7a305e5" class="outline-4">
<h4 id="org7a305e5"><span class="section-number-4">2.7.4</span> 遗留问题</h4>
<div class="outline-text-4" id="text-2-7-4">
<ol class="org-ol">
<li class="on"><code>[X]</code> 为什么区分占桌机器人和陪玩机器人??
站桌机器人: GameRoom初始化时候, rand的 robot
陪玩机器人: 因为rand的数目是随机的, 所以即使有真人玩家坐下, 也未必人满; 这时候来检测, 并分配机器人
结论:
<ol class="org-ol">
<li>站桌机器人由GameRoom自行处理</li>
<li>陪玩机器人, 可以检测</li>
</ol></li>
<li class="on"><code>[X]</code> <p>
站桌机器人是否需要定时器处理
没必要理由:
</p>
<ol class="org-ol">
<li>效率太低</li>
<li>GameRoom初始化时候, 可以主动安排机器人入座; 更符合逻辑习惯</li>
</ol>
<p>
存在理由:
</p>
<ol class="org-ol">
<li>担心初始化失败? 是否存在这种情形, 即使存在, 也不需要在这里进行判断</li>
</ol>
<p>
结论:
不需要这样处理
</p></li>
<li class="off"><code>[&#xa0;]</code> 如果保留RobotManager, 那么RobotManager也应该是继承PlayerManager</li>
</ol>
</div>
</div>

<div id="outline-container-org550b4ad" class="outline-4">
<h4 id="org550b4ad"><span class="section-number-4">2.7.5</span> 修改范围</h4>
<div class="outline-text-4" id="text-2-7-5">
<ol class="org-ol">
<li>GameRoomManager移动到GameServer</li>
<li>Robot 逻辑移动到 subgame, 在subgame中设计接口</li>
<li>优化部分函数</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org3109f9a" class="outline-3">
<h3 id="org3109f9a"><span class="section-number-3">2.8</span> <span class="done DONE">DONE</span> GameRoom</h3>
<div class="outline-text-3" id="text-2-8">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-09-09 Mon] </span></span> [done]</li>
</ul>
</div>
<div id="outline-container-org3ebdae6" class="outline-4">
<h4 id="org3ebdae6"><span class="section-number-4">2.8.1</span> player与gameroom交互</h4>
<div class="outline-text-4" id="text-2-8-1">
<ol class="org-ol">
<li>加入房间
设置RoomID
初始化椅子位置 TablePosId -1 // TODONOW 如果这个之后会kick out玩家, 那么是否有问题</li>
<li>坐下
设置椅子位置 TablePosId
设置玩家状态 USER<sub>STATE</sub><sub>SIT</sub><sub>DOWN</sub></li>
</ol>
<ol class="org-ol">
<li>准备
设置准备状态SetPlayerReadyStatus(true)
设置玩家状态 USER<sub>STATE</sub><sub>READY</sub></li>
<li>起立
设置椅子位置 TablePosId -1   TODONOW wait for lobby ack leave room
设置玩家状态 USER<sub>STATE</sub><sub>IN</sub><sub>GAME</sub>
设置准备状态 SetPlayerReadyStatus(false)</li>
<li>离开
设置椅子位置 TablePosId -1
PlayerManager::Instance中删除玩家</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-orgda54f3f" class="outline-3">
<h3 id="orgda54f3f"><span class="section-number-3">2.9</span> sub框架整理</h3>
<div class="outline-text-3" id="text-2-9">
<p>
详见 SubGame模板工程中的README
</p>
</div>
</div>
<div id="outline-container-org09c3127" class="outline-3">
<h3 id="org09c3127"><span class="section-number-3">2.10</span> <span class="done DONE">DONE</span> 常用结构体</h3>
<div class="outline-text-3" id="text-2-10">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-09-09 Mon] </span></span> [done]</li>
</ul>
</div>
<div id="outline-container-org7081978" class="outline-4">
<h4 id="org7081978"><span class="section-number-4">2.10.1</span> Msg数据包</h4>
<div class="outline-text-4" id="text-2-10-1">
<p>
0   [&lt;- pBuffer
1
2
3
4   ] &lt;-[]包的大小 [0-n]-4; 不包含int
.   {[
.
.    ] &lt;-[]值为 htonll(m<sub>UID</sub>)
.    [
.
.   }] &lt;-[]值为htonll(m<sub>sinAddr</sub>)     {}&#x2013;HeadMsg
.   {[
.
.    ] &lt;-[]值为ntohl(m<sub>nMSgID</sub>) long
.    [
.
.    ] &lt;-[]值为ntoll(m<sub>Token</sub>)
.    [
.
n   }] &lt;-[]值为MsgBody                {}&#x2013;NetMSg
</p>

<p>
遗留问题:
</p>
<ol class="org-ol">
<li>数据没有加密</li>
</ol>
</div>
</div>
<div id="outline-container-org836330c" class="outline-4">
<h4 id="org836330c"><span class="section-number-4">2.10.2</span> 常用enum</h4>
<div class="outline-text-4" id="text-2-10-2">
<ol class="org-ol">
<li>登录错误处理
enum KICK<sub>CLIENT</sub><sub>REASON</sub>
{
CLIENT<sub>REPEAT</sub><sub>LOGIN</sub> = 0,      <i>/重复登录
CLIENT<sub>TOKEN</sub><sub>EXPIRE</sub> = 1,      /</i>
CLIENT<sub>SYSTEM</sub><sub>ERROR</sub> = 2,      //系统错误
CLIENT<sub>ROOM</sub><sub>NOT</sub><sub>FOUND</sub> = 3,    //没找到房间
CLIENT<sub>ROOM</sub><sub>FULL</sub> = 4,         //房间已满
CLIENT<sub>ROOM</sub><sub>LIMIT</sub> = 5,        //房间限制
CLIEN T<sub>ROOM</sub><sub>DISMISS</sub> = 6,      //房间已解散
CLIENT<sub>LEAVE</sub><sub>ROOM</sub> = 7,        //离开房间???
CLIENT<sub>CLEAN</sub><sub>TABLE</sub> = 8,       //清空桌子???
CLIENT<sub>ROOM</sub><sub>TIME</sub><sub>OUT</sub> = 9,     //房间超时????
CLIENT<sub>ROOM</sub><sub>BEGIN</sub><sub>DISSOLVE</sub> = 10, <i>/房间开始表决解散
CLIENT<sub>MATCH</sub><sub>PLAYER</sub><sub>RANK</sub> = 11,    /</i>
CLIENT<sub>MATCH</sub><sub>PLAYERNUM</sub><sub>ERROR</sub> = 12,  //人数错误
CLIENT<sub>MATCH</sub><sub>WAIT</sub><sub>LEAVE</sub> = 13,       //等待离开
}</li>
<li>桌子状态
enum ROOM<sub>STATE</sub>
{
ROOM<sub>STATE</sub><sub>INIT</sub> = 0,            //table初始化
ROOM<sub>STATE</sub><sub>WAIT</sub><sub>CREATE</sub> = 1,     //等待创建 &#x2013; 因为table是在[game,lobby]完全交互完成后,再创建的
//ROOM<sub>STATE</sub><sub>CREATED</sub> = 2,         //创建完成  &#x2013; 无意义
  ROOM<sub>WAIT</sub><sub>START</sub> = 3,            //等待开始
ROOM<sub>STATE</sub><sub>ROUND</sub><sub>GAME</sub><sub>START</sub> = 4,//小局开始
//ROOM<sub>STATE</sub><sub>PLAYING</sub> = 5,         //正在进行 &#x2013; 这个无意义; 小局结束之前 都是正在进行
ROOM<sub>STATE</sub><sub>ROUND</sub><sub>GAME</sub><sub>END</sub> = 6,  //小局结束
ROOM<sub>STATE</sub><sub>GAME</sub><sub>ALL</sub><sub>END</sub> = 7,    //大局结束
}</li>
<li>玩家状态 TODONOW 玩家加入|离开房间, 没有状态
enum USER<sub>STATE</sub>
{
USER<sub>STATE</sub><sub>INIT</sub> = 0,            //
USER<sub>STATE</sub><sub>IN</sub><sub>LOBBY</sub> = 1,        //在大厅
USER<sub>STATE</sub><sub>WAIT</sub><sub>IN</sub><sub>GAME</sub> = 2,    //等待进入GameServer?
USER<sub>STATE</sub><sub>IN</sub><sub>GAME</sub> = 3,         //在GameServer
USER<sub>STATE</sub><sub>SIT</sub><sub>DOWN</sub> = 4,        //坐下
USER<sub>STATE</sub><sub>READY</sub> = 5,           //准备
USER<sub>STATE</sub><sub>PLAYING</sub> = 6,         //游戏中
USER<sub>STATE</sub><sub>WAIT</sub><sub>START</sub> = 7,      //等待开始
USER<sub>STATE</sub><sub>INT</sub><sub>MIN</sub><sub>SENTINEL</sub><sub>DO</sub><sub>NOT</sub><sub>USE</sub>_ = ::google::protobuf::kint32min,
USER<sub>STATE</sub><sub>INT</sub><sub>MAX</sub><sub>SENTINEL</sub><sub>DO</sub><sub>NOT</sub><sub>USE</sub>_ = ::google::protobuf::kint32max
}</li>
<li>游戏类型
gametypeid
1 &#x2013; 金币场
2 &#x2013; 房卡场
3 &#x2013; 比赛场</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgaa04cab" class="outline-3">
<h3 id="orgaa04cab"><span class="section-number-3">2.11</span> <span class="done DONE">DONE</span> 有趣的bug</h3>
<div class="outline-text-3" id="text-2-11">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-09-09 Mon] </span></span> [done]</li>
<li class="on"><code>[X]</code> <p>
sub正常打牌, 服务器崩溃在protobuf的函数中
偶然出现, 基本必出(游戏局数增加之后)
</p>
<ol class="org-ol">
<li>崩溃在frame的MessagePareser-&gt;的FetchMessage()中的Clear()</li>
<li>崩溃在sub的protobuf的add()函数中</li>
</ol>

<p>
影响因素:
</p>
<ol class="org-ol">
<li>protobuf在智能指针中的使用</li>
<li>动态库的影响</li>
<li>2份protobuf文件, 导致的命名重合</li>
</ol>

<p>
最终结论:
</p>
<ol class="org-ol">
<li>protobuf::Message的使用问题, 需要单独为之分配内存再使用;</li>
<li>TODOLATER 怀疑protobuf:Message自己有分配内存, 具体情况需要再查看资料</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-orga7005f6" class="outline-3">
<h3 id="orga7005f6"><span class="section-number-3">2.12</span> <span class="done DONE">DONE</span> 底层接口</h3>
<div class="outline-text-3" id="text-2-12">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-09-09 Mon] </span></span> [done]</li>
<li><p>
<a href="SystemModule/BaseCode/EventLoop.cpp#orgde34680">EventLoop 事件循环监听</a>
</p>
<ol class="org-ol">
<li>维护了epoll对象</li>
<li>socket接口封装</li>
<li>Connection管理</li>
</ol>

<p>
处理流程:
</p>
<ol class="org-ol">
<li>由EventTimermanager获取到当前时间 对应的 timer</li>
<li>由epoll 判断是否有事件, 没有则退出</li>
<li>如果有事件(可能是多个事件,由m<sub>eli.nMaxConnPerEvent控制</sub>), 则执行事件操作(read write)</li>
<li>循环检测: 不管timer有无events, 都会删除过去的timer</li>
<li>循环检测: 删除失效的socket连接</li>
</ol></li>
<li>Timermanager 获取时间
m<sub>mstm</sub> =  (unsigned long)(m<sub>tmval.tv</sub><sub>sec</sub> * 1000 + m<sub>tmval.tv</sub><sub>usec</sub> / 1000);
因为m<sub>tmval.tv</sub><sub>usec为毫秒</sub>, 取值为[0-999], 所以m<sub>tmval.tv</sub><sub>usec</sub> / 1000 其实是舍弃了毫秒
所以这个函数获取的时间是秒级别的</li>
<li>EventTimermanager
维护了一个红黑树</li>
<li>Eventchannel
epoll的单个事件处理</li>
<li>EventCallback
接口类, 在Eventchannel中被调用;
分别被Accetp, Connector和Connection实现</li>
<li>Accept
socket的server端
内部使用原生socket接口实现</li>
<li>Connector
socket的client端
内部使用原生socket接口实现
自己是client, 向server连接
比如lobby向DB连接;  Game向lobby连接时候 调用该类</li>
<li>Connection
client socket类
Connection与socketID一一绑定</li>
<li>Connectionmanager
Connection的管理类</li>
<li>OnMessagecallback &#x2013; 函数指针</li>
<li>Circuitqueue
数据收发 中间层</li>
</ul>
</div>
<div id="outline-container-org0eb1183" class="outline-4">
<h4 id="org0eb1183"><span class="section-number-4">2.12.1</span> 流程</h4>
<div class="outline-text-4" id="text-2-12-1">
<ol class="org-ol">
<li>Server连接其他server时候, 调用Connector类, 并在epoll(EventLoop)中记录, 然后循环检测时处理;</li>
<li>client连接server
<ol class="org-ol">
<li>Server中调用Accept类, 开启socket listen;</li>
<li>有client连接时, 在epoll中记录, 并把sockt::accept转给对应的Connection的GetAcceptCallback;
GetAcceptcallback返回的是函数指针;
函数指针在server中可自行注册;
比如, GameServer中:
<a href="SystemModule/GameServer/GameCtrl.cpp#orgc5a2d6a">此处注册了函数指针</a>(由EventLoop-&gt;ConnectionManager, 再传递给Connection)</li>
</ol></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org0a7c1ec" class="outline-3">
<h3 id="org0a7c1ec"><span class="section-number-3">2.13</span> <span class="done DONE">DONE</span> DB多线程</h3>
<div class="outline-text-3" id="text-2-13">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-09-09 Mon] </span></span> [done]</li>
</ul>
<p>
关注点
进程中 <span class="underline">公共内存</span> (static, 全局数据)的 <span class="underline">写操作</span>
</p>
</div>
<div id="outline-container-orgbc1c9f6" class="outline-4">
<h4 id="orgbc1c9f6"><span class="section-number-4">2.13.1</span> 流程</h4>
<div class="outline-text-4" id="text-2-13-1">
<ol class="org-ol">
<li>DBServer初始化DBProxyCtrl, Ctrl中初始化线程</li>
<li>线程<a href="SystemModule/BaseCode/Thread.cpp#orgdd8f49b">启动函数</a>中连接数据库, 并执行run()</li>
<li><a href="SystemModule/DBProxyServer/DBProxyCtrl.cpp#org713d354">DBProxyCtrl中收到数据校验后, 执行dbhandle线程的GetOneCode</a></li>
<li>线程的run()函数中, 检测到GetOneCode结果变动后, 解析msg, 并交给PacketHandler执行</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org464ff9b" class="outline-3">
<h3 id="org464ff9b"><span class="section-number-3">2.14</span> 定时器</h3>
<div class="outline-text-3" id="text-2-14">
<p>
缺少的功能:
</p>
<ol class="org-ol">
<li>不应该修改到定时器中的值</li>
<li>设置定时器的时候可以传递参数, 并且参数应该可以在处理定时器的时候返回</li>
</ol>
</div>
</div>
<div id="outline-container-org7f7239b" class="outline-3">
<h3 id="org7f7239b"><span class="section-number-3">2.15</span> <span class="todo TODO">TODO</span> 进程管理工程</h3>
<div class="outline-text-3" id="text-2-15">
<p>
写一个工具, 完成以下功能:
target
</p>
<ol class="org-ol">
<li>监控各个程序
<ol class="org-ol">
<li>cpu, mem等系统资源</li>
<li>错误信息</li>
</ol></li>
<li>配置 &amp;&amp; 启动 &amp;&amp; 关闭</li>
<li>重载Server进程输出</li>
</ol>
</div>
<div id="outline-container-org5871252" class="outline-4">
<h4 id="org5871252"><span class="section-number-4">2.15.1</span> 设计考量</h4>
<div class="outline-text-4" id="text-2-15-1">
<ol class="org-ol">
<li>需不需要ui界面
结论: 使用字符界面
<ol class="org-ol">
<li>运行环境 &#x2013; linux server, 无gui</li>
<li>也没有必要使用gui, 使用字符界面即可</li>
</ol></li>
<li>需要的功能
<ol class="org-ol">
<li>配置信息展示
程序没启动时候, 显示这个window
<ul class="org-ul">
<li>主要信息显示</li>
<li>启动, 关闭程序的功能</li>
<li>配置信息修改功能</li>
<li>一键跳转到配置文件位置</li>
</ul></li>
<li>错误展示</li>
<li>监控信息
程序运行时候, 显示这个window
<ul class="org-ul">
<li>程序运行状况 &#x2013; cpu, 内存一览</li>
<li>程序错误日志 显示 &#x2013; 滚动翻页 &#x2013; log日志</li>
<li>关闭, 启动功能</li>
</ul></li>
<li>启动, 关闭</li>
</ol></li>
</ol>
</div>
</div>
<div id="outline-container-org8f7f558" class="outline-4">
<h4 id="org8f7f558"><span class="section-number-4">2.15.2</span> 需要的类</h4>
<div class="outline-text-4" id="text-2-15-2">
<ol class="org-ol">
<li class="on"><code>[X]</code> Ui界面
ncurses实现
<ol class="org-ol">
<li>总体显示类</li>
<li>Table显示类</li>
</ol></li>
<li class="on"><code>[X]</code> CCfg
fstream + string实现
完成config文件的读写操作</li>
<li class="off"><code>[&#xa0;]</code> Clog
记录log文件</li>
<li class="on"><code>[X]</code> shell交互
<ol class="org-ol">
<li>system()
启动子进程处理, 调用完毕, 返回到当前进程, 并获得shell是否执行成功的int结果</li>
<li>exec()
使用当前进程处理, 本程序失效, 进入调用程序</li>
<li>popen()
启动子进程处理, 并获得shell的输出;
shell的输出将保存到FILE* 中</li>
</ol></li>
<li class="off"><code>[&#xa0;]</code> 内存信息读取类</li>
<li class="off"><code>[&#xa0;]</code> ??监控log文件 或者 server告之</li>
</ol>
</div>
</div>

<div id="outline-container-org89e51a9" class="outline-4">
<h4 id="org89e51a9"><span class="section-number-4">2.15.3</span> 使用的技术</h4>
<div class="outline-text-4" id="text-2-15-3">
<ol class="org-ol">
<li>ui table界面显示的时候, 使用线程处理.
更准确的说, 启用3个不同的线程, 分别处理三种信息的展示</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org1696a5c" class="outline-3">
<h3 id="org1696a5c"><span class="section-number-3">2.16</span> 当前服务器缺陷</h3>
<div class="outline-text-3" id="text-2-16">
<ol class="org-ol">
<li><p>
因为pid文件的存在, 导致无法开启多进程
难点:
</p>
<ol class="org-ol">
<li>如果不使用pid, 又如何知道 server &#x2013; kinid的关系?</li>
</ol>

<p>
解决方案:
</p>
<ol class="org-ol">
<li><p>
启动一个新的管理进程, 来通知server 应该关闭
管理进程 &#x2013; 选择kind + node
通知哪个server?  是不是需要注册一下? 或者在lobby中获取?
通知到该server之后, server应该怎么处理?
</p>

<p>
无法通过调用kill()函数退出, 因为不知道pid
可以通过退出while(1)循环, 来保证server的退出
</p></li>
</ol></li>
<li>game server与room type绑定到了一起
room type
<ul class="org-ul">
<li>房卡场</li>
<li>金币场</li>
<li>比赛场</li>
</ul></li>
<li>攻击lobby可直接使整个服务器瘫痪
俗称的 一打就死</li>
</ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: 王成庆</p>
<p class="date">Created: 2019-09-09 Mon 12:14</p>
</div>
</body>
</html>
